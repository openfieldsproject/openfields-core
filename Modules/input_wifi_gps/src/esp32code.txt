#include <WiFi.h>
#include <WiFiClient.h>
#include "mbedtls/aes.h"

// WiFi credentials
#define WIFI_SSID "YOUR_SSID"
#define WIFI_PASS "YOUR_PASS"

// BeagleBone server
#define SERVER_IP   "192.168.1.100"
#define SERVER_PORT 5005

// AES key (16 bytes)
uint8_t aesKey[16] = {0x00,0x11,0x22,0x33,0x44,0x55,0x66,0x77,
                      0x88,0x99,0xaa,0xbb,0xcc,0xdd,0xee,0xff};

WiFiClient client;
HardwareSerial &gpsSerial = Serial1; // GPS UART

unsigned long lastReconnectAttempt = 0;
const unsigned long reconnectInterval = 5000; // 5 seconds

void connectWiFi() {
  if (WiFi.status() != WL_CONNECTED) {
    WiFi.begin(WIFI_SSID, WIFI_PASS);
    unsigned long start = millis();
    while (WiFi.status() != WL_CONNECTED && millis() - start < 10000) {
      delay(500);
      Serial.print(".");
    }
    if (WiFi.status() == WL_CONNECTED) {
      Serial.println("WiFi connected");
    } else {
      Serial.println("WiFi connect failed, retrying later");
    }
  }
}

void connectServer() {
  if (!client.connected()) {
    if (client.connect(SERVER_IP, SERVER_PORT)) {
      Serial.println("Connected to server");
    } else {
      Serial.println("Server connect failed, will retry");
    }
  }
}

void sendNMEAMessage(const char* nmea) {
  if (!client.connected()) {
    connectServer();
    if (!client.connected()) return; // skip if still disconnected
  }

  size_t nmeaLen = strlen(nmea);
  size_t paddedLen = ((nmeaLen / 16) + 1) * 16;
  uint8_t plain[128] = {0};
  memset(plain, 0, sizeof(plain));
  memcpy(plain, nmea, nmeaLen);
  uint8_t pad = (uint8_t)(paddedLen - nmeaLen);
  for (size_t i = 0; i < pad; i++) plain[nmeaLen + i] = pad;

  // random IV
  uint8_t iv[16];
  for (size_t i = 0; i < 16; i++) iv[i] = random(0, 256);

  uint8_t cipher[128] = {0};
  mbedtls_aes_context ctx;
  mbedtls_aes_init(&ctx);
  mbedtls_aes_setkey_enc(&ctx, aesKey, 128);
  mbedtls_aes_crypt_cbc(&ctx, MBEDTLS_AES_ENCRYPT, paddedLen, iv, plain, cipher);
  mbedtls_aes_free(&ctx);

  client.write(iv, 16);
  uint32_t clen = htonl(paddedLen);
  client.write((uint8_t*)&clen, 4);
  client.write(cipher, paddedLen);
}

void setup() {
  Serial.begin(115200);
  gpsSerial.begin(9600); // set to GPS baud rate
  connectWiFi();
  connectServer();
}

void loop() {
  // WiFi/server watchdog
  if (millis() - lastReconnectAttempt > reconnectInterval) {
    connectWiFi();
    connectServer();
    lastReconnectAttempt = millis();
  }

  // Read GPS
  while (gpsSerial.available()) {
    String line = gpsSerial.readStringUntil('\n');
    line.trim();
    if (line.startsWith("$GPRMC") || line.startsWith("$GPGGA")) {
      sendNMEAMessage(line.c_str());
      delay(5); // small spacing to avoid flooding
    }
  }

  delay(10); // yield time for background tasks
}
